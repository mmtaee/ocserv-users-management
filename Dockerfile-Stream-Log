# -----------------------------
# Builder Stage
# -----------------------------
FROM golang:1.25.0 AS builder

ENV GIN_MODE=release
ENV CGO_ENABLED=1
ENV GOOS=linux
ENV GOARCH=amd64

# Optional: copy common packages if used
RUN mkdir /common
COPY ./common /common

# Set working directory
WORKDIR /app

# Copy Go module files first for caching
COPY ./stream_log/go.mod ./stream_log/go.sum ./
RUN go mod download

# Copy the rest of the source
COPY ./stream_log .

# Build the binary with optional size optimization
RUN go build -ldflags="-s -w" -o stream_log main.go

# -----------------------------
# Final Stage
# -----------------------------
FROM debian:trixie-slim

# Install runtime dependencies only
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        sqlite3 \
        libsqlite3-dev && \
    rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy the Go binary from the builder stage
COPY --from=builder /app/stream_log /usr/local/bin/stream_log

# Make binary executable
RUN chmod +x /usr/local/bin/stream_log

# Set up volume for database persistence
VOLUME ["/usr/local/bin/db"]

# Expose application port
EXPOSE 8080

# Default command
CMD ["stream_log"]
